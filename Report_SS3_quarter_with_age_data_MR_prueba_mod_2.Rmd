---
title: "Assessment for WKBANSP 2024 using age-structured data in SS3: Anchovy in ICES Subdivision 9a South (ane.27.9a Southern component)"
author: |
  María José Zúñiga\thanks{Centro Oceanográfico de Cádiz (COCAD-IEO), CSIC},
  Margarita María Rincón\thanks{Centro Oceanográfico de Cádiz (COCAD-IEO), CSIC},
  Fernando Ramos\thanks{Centro Oceanográfico de Cádiz (COCAD-IEO), CSIC}
output:
 pdf_document: 
  keep_tex: true
  extra_dependencies: ["float"]
  #fig_width: 6
    # word_document:
    # fig_caption: yes
    # reference_docx: "boot/data/sec_04_template.docx"
toc: false
bibliography: "boot/data/report_biblio.bib"
csl: "boot/data/ices-journal-of-marine-science.csl"
---



```{r pkgs, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(icesAdvice)
library(flextable)
library(FLCore)
library(officedown)
library(officer)
library(TAF)
library(png)
library(grid)
library(gridExtra)
library(tidyverse)
```


```{r setup, knitr, echo=FALSE, message=FALSE, warning=FALSE}
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H",fig.align = 'center',out.width = "95%" )


# To print the inline numbers using normal notation and not scientific notation.
options(scipen=999)

```


```{r caption_settings}
# tabruns.start <- list(
#    # run_word_field("STYLEREF 2 \\s"),
#    # ftext("."),
#   run_autonum(seq_id = "Table", pre_label = "", post_label = "", tnd=3, tns=".", start=1)
# )
# 
# tabruns <- list(
#   run_autonum(seq_id = "Table", pre_label = "", post_label = "", tnd=3, tns=".")
# )
# 
# figruns.start <- list(
#   run_autonum(seq_id = "Figure", pre_label = "", post_label = "", tnd=3, tns=".", start=1)
# )
# 
# figruns <- list(
#   run_autonum(seq_id = "Figure", pre_label = "", post_label = "", tnd=3, tns=".")
# )

```

```{r officer_landscape}


```


```{r load}
run_esc<-"boot/data/run/" 
esc<-readLines(paste0(run_esc,"Esc.txt")) 


path_dat<-paste0("data/run/",esc)
path_mod<-paste0("report/run/",esc)
path_out<-paste0("output/run/",esc)
path_retro<-paste0("report/retro/",esc)
# load
load(paste0(path_mod,"/report.RData"))
load(paste0(path_mod,"/tables_run.RData"))
load(paste0(path_dat,"/inputData.RData"))
load(paste0(path_out,"/output.RData"))
load(paste0(path_retro,"/rho.RData"))
```

```{r}
#block_section(op_section) # open section
fig_counter <- 1

# Función para generar referencias automáticas
run_reference <- function(label) {
  label_ref <-fig_counter# paste("Figura", fig_counter, "-", label)
  return(label_ref)
}

# Función para incrementar el contador cada vez que generes una figura
increment_figure_counter <- function() {
  fig_counter <<- fig_counter + 1
}

```

```{r setup, include=FALSE}
# Definir la función para convertir las figuras
convert_figures <- function(lines) {
  # Patrón para buscar include_graphics
  graphics_pattern <- "include_graphics\\((.*)\\)"
  # Patrón para buscar la referencia a la figura
  reference_pattern <- "Figure `r run_bookmark\\(\"(.*?)\", (tabruns|figruns|figruns\\.start|tabruns\\.start)\\)`:\\s*(.*)"

  # Nueva lista para almacenar líneas convertidas
  new_lines <- character(length(lines))
  
  i <- 1
  while (i <= length(lines)) {
    line <- lines[i]
    
    # Reemplazar include_graphics y la referencia a la figura
    if (grepl(graphics_pattern, line)) {
      # Captura el nombre del archivo gráfico
      file_name <- sub(graphics_pattern, "\\1", line)
      
      # Buscar la línea en blanco y la línea de referencia
      if (i + 2 <= length(lines) && lines[i + 1] == "" && grepl(reference_pattern, lines[i + 2])) {
        caption_line <- lines[i + 2]
        parts <- regmatches(caption_line, regexec(reference_pattern, caption_line))
        fig_caption <- parts[[1]][3]  # Captura el subtítulo
        
        # Crear nueva línea con fig.cap y la llamada a include_graphics
        new_lines[i] <- paste0('```{r fig.cap="ane.27.9a Southern stock. ', fig_caption, '"}\n',
                                'include_graphics(', file_name, ')\n',
                                'increment_figure_counter()\n```')
        # Saltar las líneas del caption original y la línea en blanco
        i <- i + 3
        next
      }
    }
    
    # Mantener la línea original si no coincide
    new_lines[i] <- line
    i <- i + 1
  }
  
  return(new_lines)
}

```

# Assessment model

The assessment of the anchovy in ICES division 9a, southern component was performed in Stock Synthesis software, version 3.30.22.1 [SS3, @Methot2024] under the Linux platform. SS3 is a generalized age and/or length-based model that is very flexible with regard to the types of data that may be included, the functional forms that are used for various biological processes, the level of complexity and number of parameters that may be estimated. The model is coded in C++ with parameter estimation enabled by automatic differentiation (www.admb-project.org) and available at the NOAA Fisheries integrated toolbox: https://noaa-fisheries-integrated-toolbox.github.io/SS3. A description and discussion of the model can be found in @Methot2013.

The model is defined quarterly between 1989 and 2023, for one area and it is age-based, where the population is comprised of 3+ age-classes (with age 3 representing a plus group) with sexes combined (male and females are modelled together).

# Data

Input data include total catch (in biomass) and age composition of the catch (in proportion) for the commercial fleet (*SEINE*); abundance (in biomass) and age composition  from three annual surveys: *PELAGO*, *ECOCADIZ* and *ECOCADIZ-RECLUTAS*; and spawning-stock biomass (SSB) estimates from a triennial DEPM *BOCADEVA* survey. To account for catches seasonality, the *SEINE* fleet have been divided into four fleets, one per quarter.

The Figure `r run_reference("fig_input_data")` provides a visual representation of the input data used in the model, categorized into three main types: catches, abundance indices, and age compositions. These data are displayed over time (years) and are represented by circles, with the size of each circle reflecting the magnitude of the data.

```{r fig.cap="ane.27.9a Southern stock. Summary of model data input by year, where circle area is relative within a data type. Circles are proportional to total catch for catches, to precision for indices and to total sample size for age compositions."}
include_graphics(file.path(path_mod,"fig_input_data.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```


## Catches

Anchovy catches in the Gulf of Cádiz exhibit seasonality, with 40.61% concentrated in the second quarter (Q2), averaging 2120.26 tons historically, followed by the third quarter (Q3) with 29.60% (1545.23 tons), the first quarter (Q1) with 19.39% (1012.42 tons), and the fourth quarter (Q4) with 10.39% (542.61 tons). In 2023, first-quarter catches were 7.84% lower than the historical average, while second, third, and fourth-quarter catches increased by 71.03%, 48.06%, and 14.70%, respectively (Figures `r run_reference("fig_catches")` and 3).
```{r fig.cap="ane.27.9a Southern stock. Time series of quarterly catches."}
include_graphics(file.path(path_mod,"fig_catches.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```
<!-- and `r run_reference("tb_catches")`). -->

```{r fig.cap="ane.27.9a Southern stock. Time series data of quarterly catches "}
include_graphics(file.path(path_mod,"tb_catches.png"))#, auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




  

## Abundance indices

The abundance indices *PELAGO*, *ECOCADIZ*, *BOCADEVA*, and *ECOCADIZ-RECLUTAS* exhibit interannual variability over time (Figure `r run_reference("index9_standcpueall")`). *PELAGO*, with data from 1999 to 2023, shows fluctuations with a peak in 2016 at 65,345 tons, followed by a decline, but with a slight recovery in 2023 to 26,786 tons. *ECOCADIZ*, covering the period from 2004 to 2023, reaches its maximum in 2019 at 57,700 tons, followed by a significant decrease to 9,714 tons in 2023. *BOCADEVA*, with data from 2005 to 2023, shows a steady increase to its peak in 2020 at 81,466 tons, followed by a reduction to 15,138 tons in 2023. *ECOCADIZ-RECLUTAS*, recorded from 2014 to 2023, shows a sustained increase until 2019 at 48,398 tons, followed by a decrease to 8,300 tons in 2023. 

```{r fig.cap="ane.27.9a Southern stock. Biomass estimates from PELAGO, ECOCADIZ, BOCADEVA, and ECOCADIZ-RECLUTAS surveys."}
include_graphics(file.path(path_mod,"/fig_indiceBiomass.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

As it can be observed also in the raw data  (Figure `r run_reference("tb_index")`), these patterns reflect a high variability in abundance over time with periods of increase followed by declines in the later years of each series.

```{r fig.cap="ane.27.9a Southern stock. Acoustic biomass (ton) by surveys *PELAGO*, *ECOCADIZ*, *BOCADEVA*, and *ECOCADIZ-RECLUTAS*.   "}
include_graphics(file.path(path_mod,"tb_index.png"))#, auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




## Age composition

In the  model, the age proportion of the commercial fleet (*SEINE*) by quarter from 1989 to 2023, is used (Figure `r run_reference("fig_agecomp_by_quartersSeine")`). It can be observed that age-0 proportion compared to other ages has been increasing in the last years while age-1 predominates in Q1 and Q2, with a constant proportion over time. Age-0 is not recorded in Q1 and Q2 by convention.  In Q3 and Q4, the proportion of age-1 individuals decreases as the proportion of age-0 increases. Additionally, ages 2 and 3 exhibit lower and variable proportions across all quarters over the years, without a defined pattern of change.



```{r fig.cap="ane.27.9a Southern stock. Age proportion in the commercial fleet catches (*SEINE*) by quarter (1989 to 2023)."}
include_graphics(file.path(path_mod,"fig_agecomp_by_quartersSeine.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




  

Figure `r run_reference("fig_agecomp_by_quartersSurveys")` shows the yearly age proportions from surveys *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS* that were used as input for the model. It can be observed that in the *PELAGO* survey, conducted in the second quarter (Q2), age 1 represents the highest proportion over time, with a presence of ages 2 and 3, and no records of age 0 individuals. The *ECOCADIZ* survey, primarily conducted in the third quarter (Q3), shows a predominance of age 1, with an increase in the proportion of age 0 from 2010 onwards; in 2004 and 2006, when the survey was conducted in the second quarter (Q2), no age 0 individuals were recorded by convention. The *ECOCADIZ-RECLUTAS* survey, conducted since 2014 in October (fourth quarter, Q4), shows a higher proportion of age 0, followed by age 1, with lower representation of ages 2 and 3.


```{r fig.cap="ane.27.9a Southern stock. Age proportion in acoustic surveys estimates  (*PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS*)."}
include_graphics(file.path(path_mod,"fig_agecomp_by_quartersSurveys.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




  

## Weigth-at-age

Figure `r run_reference("fig_weight_by_quarters")` presents the age-specific weight-at-age values at the start of each season, estimated from external data sources. The figure illustrates that mean weight differences between age groups remain consistent over time, with some variability observed across quarters. Individuals aged 3 show greater variability in mean weight compared to younger age groups. For further details, refer to the working document by **Zuñiga et al. (2024)**.

```{r fig.cap="ane.27.9a Southern stock. Weight at age by quarters."}
include_graphics(file.path(path_mod,"fig_weight_by_quarters.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




## Model settings

### Natural mortality

Age-specific natural mortality input values at the beginning of the year were derived from external data sources. For further details, refer to the working document by **Rincón et al. (2024)**.

```{r}
include_graphics(file.path(path_mod,"tb_natM.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
```


### Maturity

Due to some inconsistencies in the maturity ogives not noticed during WKPELA 2018, we assume that all individuals with age 1 or higher ($B_{1^+}$), are mature i.e. these abundance estimates result equivalent to spawning stock biomass ($SSB$) estimates. For further details, refer to the working document by **ICES 2024 and  WD Rincón et al. (2024)**.

```{r}
include_graphics(file.path(path_mod,"tb_maturity.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
```


### Growth

It is not modelled explicitly. 


### Recruitment

Equilibrium recruitment ($R_0$)  was estimated in the base model, and steepness (h) was fixed at 0.8. The initial steepness estimate is based on values reported by @Hsu2024 , with a mean of 0.82 and a range of 0.59 to 0.93, and by @Wiff2018, who reported steepness values between 0.58 and 0.86 for pelagic species. Standard deviation of log number of recruits was set to 0.6. 

The early recruitment deviations for the initial population were estimated for the period 1985-1988. A recruitment bias adjustment ramp [@Methot2011] was applied to this early period, and bias-adjusted recruitment was estimated for the main period. Recruitment deviations for the main period were estimated for 1991-2023.


<!-- Jhen Hsu et al. (2024) 
Wiff et al. (2018) -->

<!-- Annual recruitments are defined as parameters and the functional relationship for the spawner-recruitment is such that steepness is ignored and there is no bias adjustment. Standard deviation of log number of recruits was set to 0.6.  -->

### Fishing mortality

Calculation of fishing mortality is performed by using the hybrid F method that does a Pope’s approximation to provide initial values for iterative adjustment of the Baranov continuous F values to closely approximate the observed catch. Total catch biomass by year is assumed to be accurate and precise and the F values are tuned to match this catch. 

### Catchability

All the surveys are assumed to be relative indices of abundance. The catchability is modelled with a simple $q$ linear model.

### Selectivity

The fishery and the surveys selectivity were defined as logistic functions fixed over time. Nevertheless, considering the difference in age patterns over the years in the *ECOCADIZ* survey it was decided to split it into two periods: 2004-2014 and 2015-2023. <!-- se usan bloques de selectividad--> 
<!-- (**Figure xx**).  In *PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS* surveys was set as a logistic function fixed over time (**Figure xx**). -->

### Data weighting

Constant standard errors of 0.05 and 0.3 were assumed for quarterly catches and surveys, respectively.
<!-- Coeficient of variation (CV): A standar error of 0.05 was assumed for all quarters of catches and 0.3 for the *PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS* surveys, and spawning-stock biomass (SSB) from triennial DEPM *BOCADEVA* survey, reflecting the accurate sampled catches and the CV level of the surveys. A standard error of 0.3 is assumed for all years for the DEPM index based on the uncertainty of the SSB estimates. -->

<!-- Sample size (nm):  -->
The age compositions were adjusted assuming a multinomial error structure with variance described by the sample size, set at 100 for both, the commercial fleet and acoustic surveys. After that, these data was weighted using the Francis method TA1.8 [@Francis2011]. 


### Initial population

It is calculated by estimating an initial equilibrium population modified by age composition data in the first year of the assessment [@Methot2013]. The model starts in 1988 and the equilibrium population age structure was assumed to be in an exploited state with an initial catch of 0 tonnes <!-- corresponding to the average catches first 5 years of data (1989-93.)  -->


<!-- A summary of the model key model assumptions and parameters for the Stock Synthesis is available in Figure `r run_reference("tb_dat_stru")`. -->



```{r eval=F, fig.cap="ane.27.9a Southern stock. Input data type, model assumptions and settings for the assessment  with data series 1989-2023."}
include_graphics(file.path(path_mod,"tb_dat_stru.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




Variance estimates for all estimated parameters are calculated from the Hessian matrix. Minimisation of the likelihood is implemented in phases using standard ADMB process. The phases in which estimation will begin for each parameter are shown in the control file available in the TAF repository for this stock <!--(https://github.com/ices-taf/2024_ane.27.9a_south_benchmark)-->. The R packages r4ss version `r packageVersion("r4ss")`  [@Taylor2021] and ss3diags version `r packageVersion("ss3diags")` [@Carvalho2021] were used to process and view model outputs. All analyses were conduction in `r R.version.string`.

  

# Diagnostics

The  model successfully converged, as evidenced by the Hessian matrix being positive definite and the final gradient being relatively small, with a gradient value of `r convergency`. The "Status" column in Figure `r run_reference("tb_params_est")` shows that the initial model configuration has allowed for adequate optimization of the parameters. Additionally, the gradient for all parameters is relatively small. It is important to note that the bounds imposed on the initial parameters have not restricted the search for optimized values, as reflected in the "Afterbound" column.




```{r fig.cap="ane.27.9a Southern stock. Parameters estimated by the initial base model."}
include_graphics(file.path(path_mod,"tb_params_est.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




## Model fit and residuals

The Figure `r run_reference("fig_indices_fit")` shows that the abundance indices from the acoustic surveys exhibit a high level of variability, as reflected by the width of the assumed confidence intervals, with a maximum coefficient of variation of 30%. The model follows the overall trend of the indices, though it encounters some difficulties in accurately fitting the extreme biomass values, both the highest and lowest. However, it adequately reproduces the general trend of variability in biomass levels presented by the survey estimates.


```{r fig.cap="ane.27.9a Southern stock. Model fit to the data (left panel) and observed versus expected values (right panel) of the indices from the surveys *PELAGO*, *ECOCADIZ*, *BOCADEVA* and *ECOCADIZ-RECLUTAS*. The lines indicate a 95% uncertainty interval around the index values based on the lognormal error model assumption. "}
include_graphics(file.path(path_mod,"fig_indices_fit.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```



Figure `r run_reference("fig_runtest_residuals_indices")` shows that the residuals from the fit of the biomass indices are randomly distributed, with p-values greater than 0.05 (*PELAGO* = `r run_cpue[run_cpue$Index=="PELAGO","runs.p"]`, *ECOCADIZ* = `r run_cpue[run_cpue$Index=="ECOCADIZ","runs.p"]`, *BOCADEVA* = `r run_cpue[run_cpue$Index=="BOCADEVA","runs.p"]`, *ECOCADIZ-RECLUTAS* = `r run_cpue[run_cpue$Index=="ECORECLUTAS","runs.p"]`). The estimated root mean square error (RMSE) for the joint residual analysis is `r jaba_cpue[jaba_cpue$indices == "Combined", "RMSE.perc"]`%.


```{r fig.cap="ane.27.9a Southern stock. a) Run test plots for the fit of acoustic and DEPM survey indices. Green shading indicates no evidence (p>=0.05) and red shading indicates evidence (p<0.05) for rejecting the hypothesis of a randomly distributed residual time series, respectively. The shaded area (green/red) spans three standard residual deviations on either side of zero, and red points outside the shading violate the three-sigma limit for that series. b) Joint residual plots for the fit of acoustic and DEPM survey indices (bottom left panel).  Vertical lines with points show the residuals, and the solid black line show loess smoother through all residuals. Boxplots indicate the median and quantiles in cases where residuals from multiple indices are available for a given year, with the solid black line showing a loess smoother. The root mean square error (RMSE) is included in the top right corner of the panel."}
include_graphics(file.path(path_mod,"fig_runtest_residuals_indices.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```



Estimated mean age for the *SEINE* fleet (one by quarter) with a 95% confidence intervals based on current sample sizes, is presented in Figure `r run_reference("fig_meanage_fit_SeineQ1")`. 
<!-- , the model follows the oscillation in the mean age, adjusting between 1 and 1.4 years, though it encounters some fitting issues in the later years of the series. In *ECOCADIZ*, the observed trend shows a progressive decline in mean age, starting near 1.0 and dropping below 0.5 in recent years, with the model struggling to fit this trend. Finally, in *ECOCADIZ-RECLUTAS*, the model fits well to an initial mean age below 0.5 years, increasing above 0.5 between 2016 and 2021, before decreasing again in the last two years of the series. -->


```{r fig.width=5, fig.height=6, dpi=300, fig.cap= "Mean age for commercial fleet by quarters with 95% confidence intervals based on current sample sizes. Francis data weighting method TA1.8: thinner intervals (with capped ends) show the result of further adjusting sample sizes based on the suggested multiplier (with 95% interval) for age data. The blue line corresponds to the estimated mean age."}

# Cargar las imágenes
img1 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_SeineQ1.png"))
img2 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_SeineQ2.png"))
img3 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_SeineQ3.png"))
img4 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_SeineQ4.png"))


# Convertir a grobs (graphic objects) para grid.arrange
g1 <- rasterGrob(img1, interpolate=TRUE)
g2 <- rasterGrob(img2, interpolate=TRUE)
g3 <- rasterGrob(img3, interpolate=TRUE)
g4 <- rasterGrob(img4, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g1, g2, g3, g4, ncol=1)
increment_figure_counter()

```

While mean age for the *PELAGO*, *ECOCADIZ* and *ECOCADIZ-RECLUTAS* surveys is presented in Figure `r run_reference("fig_meanage_fit_Pelago")`.


```{r fig.width=5, fig.height=6, dpi=300, fig.cap= "Mean age for *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS* with 95% confidence intervals based on current sample sizes. Francis data weighting method TA1.8: thinner intervals (with capped ends) show the result of further adjusting sample sizes based on the suggested multiplier (with 95% interval) for age data. The blue line corresponds to the estimated mean age."}

# Cargar las imágenes
img2 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_Pelago.png"))
img3 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_Ecocadiz.png"))
#img4 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_EcocadizRecl.png"))

# Convertir a grobs (graphic objects) para grid.arrange
g2 <- rasterGrob(img2, interpolate=TRUE)
g3 <- rasterGrob(img3, interpolate=TRUE)
#g4 <- rasterGrob(img4, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g2, g3, ncol=1)
increment_figure_counter()
```



The Figure `r run_reference("fig_age_fit_agg")` shows the estimated age compositions aggregated over time for the different age data sources: *SEINE*, *ECOCADIZ*, *PELAGO*, and *ECORECLUTAS*. Overall, a high proportion of young individuals (ages 0 and 1) is observed in both the commercial fleet catches and acoustic surveys, with a significant decline in the proportions of older age classes. The green lines represent the model fits, demonstrating an adequate fit, with the aggregated age compositions well reconstructed. 


```{r fig.cap="ane.27.9a Southern stock. Model fit to the aggregated age composition data from the SEINE fishery, and the acoustic surveys *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS*. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_agg.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Figure `r run_reference("fig_age_fit_Seine")` shows the estimated age composition for the commercial fleet in the first quarter.

```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *SEINEQ1* fishery, by year and quarter. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_SeineQ1.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Figure `r run_reference("fig_age_fit_Seine")` shows the estimated age composition for the commercial fleet in the second quarter.

```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *SEINEQ2* fishery, by year and quarter. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_SeineQ2.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Figure `r run_reference("fig_age_fit_Seine")` shows the estimated age composition for the commercial fleet in the third quarter.

```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *SEINEQ3* fishery, by year and quarter. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_SeineQ3.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Figure `r run_reference("fig_age_fit_Seine")` shows the estimated age composition for the commercial fleet in the fourth quarter.

```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *SEINEQ4* fishery, by year and quarter. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_SeineQ4.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Although the aggregated fits show an overall adequate result, some years exhibit variability in the age composition of the commercial fleet (*SEINE*) catches. This pattern is also evident in the annual data fits for the *PELAGO* survey, especially in the later years of the series (2020-2023), where there is a tendency to overestimate age 1 and underestimate age 2 (Figure `r run_reference("fig_age_fit_Pelago")`). 

```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *PELAGO* spring survey by year. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_Pelago.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```


In the *ECOCADIZ* survey, there are difficulties in estimating ages 0 and 1, with a tendency to underestimate age 0 and overestimate age 1 from 2016 to 2023 (Figure`r run_reference("fig_age_fit_eco")`).


```{r fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *ECOCADIZ* summer survey by year. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_Ecocadiz.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

In *ECOCADIZ-RECLUTAS*, a generally good fit is observed without a clear pattern of overestimation or underestimation (Figure `r run_reference("fig_age_fit_ecorec")`). 

```{r eval=F,fig.cap="ane.27.9a Southern stock. Model fit to the age composition data from the *ECOCADIZ-RECLUTAS* fall survey by year. The green line represents the model estimates, while the shaded grey area shows the observed data."}
include_graphics(file.path(path_mod,"fig_age_fit_EcocadizRecl.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```


Bubble plots of the residuals corresponding to the fit of the *SEINE* data are presented in Figure `r run_reference("fig_age_residuals_seine")`.


```{r fig.width=5, fig.height=6, dpi=300, fig.cap="ane.27.9a Southern stock.  Pearson residuals, comparing across fleets. Closed bubbles are positive residuals (observed > expected) and open negative residuals (observed < expected)."}


# Cargar las imágenes
img1 <- png::readPNG(file.path(path_mod,"fig_age_residuals_SeineQ1.png"))
img2 <- png::readPNG(file.path(path_mod,"fig_age_residuals_SeineQ2.png"))
img3 <- png::readPNG(file.path(path_mod,"fig_age_residuals_SeineQ3.png"))
img4 <- png::readPNG(file.path(path_mod,"fig_age_residuals_SeineQ4.png"))

# Convertir a grobs (graphic objects) para grid.arrange
g1 <- rasterGrob(img1, interpolate=TRUE)
g2 <- rasterGrob(img2, interpolate=TRUE)
g3 <- rasterGrob(img3, interpolate=TRUE)
g4 <- rasterGrob(img4, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g1,g2, g3, g4, ncol=1)


# include_graphics(file.path(path_mod,"fig_comp_agefit_multi-fleet_comparison.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Bubble plots of the residuals corresponding to the fit of the surveys age-data are presented in Figure `r run_reference("fig_age_residuals_surveys")`.


```{r fig.width=5, fig.height=6, dpi=300, fig.cap="ane.27.9a Southern stock.  Pearson residuals, comparing across surveys. Closed bubbles are positive residuals (observed > expected) and open negative residuals (observed < expected)."}


# Cargar las imágenes
img1 <- png::readPNG(file.path(path_mod,"fig_age_residuals_Pelago.png"))
img2 <- png::readPNG(file.path(path_mod,"fig_age_residuals_Ecocadiz.png"))
#img3 <- png::readPNG(file.path(path_mod,"fig_age_residuals_EcocadizRecl.png"))

# Convertir a grobs (graphic objects) para grid.arrange
g1 <- rasterGrob(img1, interpolate=TRUE)
g2 <- rasterGrob(img2, interpolate=TRUE)
#g3 <- rasterGrob(img3, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g1,g2, ncol=1)


# include_graphics(file.path(path_mod,"fig_comp_agefit_multi-fleet_comparison.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```


The Figure `r run_reference("fig_runtest_residuals_age")` shows that the residuals from the fit of the age proportions are randomly distributed, with p-values greater than 0.05 in the case of the commercial fleet (*SEINE*: `r run_age[run_age$Index=="SEINE","runs.p"]`) and the acoustic surveys (*PELAGO*: `r run_age[run_age$Index=="PELAGO","runs.p"]`, *ECOCADIZ-RECLUTAS*: `r run_age[run_age$Index=="ECORECLUTAS","runs.p"]`). Some violations of the three-standard-deviation limit are observed for the commercial fleet (*SEINE*) during the fourth quarter of 1991, 1996, and 2012, as well as in the *PELAGO* survey in the last year of the series (2023). In the case of the *ECOCADIZ* survey, the residuals are not randomly distributed as indicated by a p-value of `r run_age[run_age$Index=="ECOCADIZ","runs.p"]`, with several violations of the three-standard-deviation limit observed, primarily from 2018 to 2023. The estimated root mean square error (RMSE) for the joint residual analysis is `r jaba_age[jaba_age$indices == "Combined", "RMSE.perc"]`%.

```{r fig.cap="ane.27.9a Southern stock. a) Runs test results for fits to annual mean age estimates for the surveys (*PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS*) and the fishery (*SEINE*). Green shaded (green/red) area spans three residual standard deviations to either side from zero, and the red points outside of the shading violate the 'three-sigma limit' for that series.  b) Joint residual plots for annual mean length estimates for surveys and fishery (bottom left panel).  Vertical lines with points show the residuals, and the solid black line show loess smoother through all residuals. Root-mean squared error (RMSE) is included in the upper right-hand corner of the panel."}
include_graphics(file.path(path_mod,"fig_runtest_residuals_age.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




  

## Retrospective analysis

Figure `r run_reference("Retro")` shows a retrospective pattern in both spawning biomass and fishing mortality in the base model. The retrospective analysis of the assessment model reveals that, in terms of Mohn's rho (mean of retrospective anomalies), the reduction in data leads to a pattern of underestimation in fishing mortality (rho = `r rho_f`) and overestimation in spawning biomass (rho = `r rho_ssb`). These Mohn´s rho values  were inside the bounds of recommended values, according to the rule proposed by @HurtadoFerro2014, which states that Mohn's rho index values should be less than 0.30 and greater than -0.22 for short-lived species.

<!-- In general, the estimates of biomass and F for the most recent years can vary substantially between successive updates, while in the earlier years, they tend to converge to stable values. The model exhibits high statistical variance in the last years of the series, resulting in greater uncertainty for projections and generating unreliable estimates for establishing management measures. -->

```{r fig.cap="ane.27.9a Southern stock. Retrospective analysis of spawning stock biomass (SSB) and fishing mortality (F). Models  conducted by re-fitting the reference model (Ref) after removing five years of observations, one year at a time sequentially. The retrospective results are shown the entire time series. Mohn's rho statistic and the corresponding 'hindcast rho' values (in brackets) are printed at the top of the panels. One-year-ahead projections denoted by color-coded dashed lines with terminal points are shown for each model. Grey shaded areas are the 95% confidence intervals from the reference model."}
include_graphics(file.path(path_retro,"Retro.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




  
# Results


## Stock-recruitment relationship

```{r include=FALSE}
param<-output$estimated_non_dev_parameters %>%rownames_to_column(var = "Parameter")
SR_LN_R0 <- param$Value[param$Parameter == "SR_LN(R0)"]

```

Recruitment was modeled using a Beverton-Holt stock-recruitment relationship (Figure `r run_reference("fig_stock-recluta")` ). The assumed level of underlying recruitment deviation error was fxed ($\sigma_R$=0.6), equilibrium recruitment was estimated ($log(R_0)$)=`r round(SR_LN_R0,2)`) and steepness ($h$) was fixed at 0.8. 

```{r fig.cap="ane.27.9a Southern stock. Stock-recruit curve with labels on first, last, and years with (log) deviations > 0.5. Point colors indicate year, with warmer colors indicating earlier years and cooler colors in showing later years."}
include_graphics(file.path(path_mod,"fig_stock-recluta.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()

```

Recruitment deviations for the early (1985-1988) and  main (1991-2023) periods in the model are presented in (Figure `r run_reference("fig_Recdevs")` ). 

```{r fig.cap="ane.27.9a Southern stock. Recruitment deviations with 95% intervals for the base model (sigmaR = 0.6 )."}
include_graphics(file.path(path_mod,"fig_Recdevs.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Asymptotic standard errors for recruitment deviations are shown in Figure `r run_reference("fig_recdevs2_varcheck")`.

```{r fig.cap="ane.27.9a Southern stock. Asymptotic standard errors for the estimated recruitment deviations."}
include_graphics(file.path(path_mod,"fig_recdevs2_varcheck.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Recruitment bias adjustment for the different periods is shown in Figure `r run_reference("fig_recruit_fit_bias_adjust")`.

```{r fig.cap="ane.27.9a Southern stock. Recruitment bias adjustment plot for early and main."}
include_graphics(file.path(path_mod,"fig_recruit_fit_bias_adjust.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```


## Selectivity

Figure `r run_reference("fig_Sel_commercial_fleet")` shows the estimated selectivity for the age composition of the commercial fleet.

```{r fig.width=7, fig.height=4, dpi=300, fig.cap="ane.27.9a Southern stock.Estimated selectivity for catch-at-age of commercial fleet (logistic shaped fixed selectivity across all years)."}
include_graphics(file.path(path_mod,"fig_Sel_commercial_fleet.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

Figure `r run_reference("fig_Sel_surveys")` shows the estimated selectivity for the age composition of the acoustic surveys 
```{r fig.cap="ane.27.9a Southern stock. Estimated selectivity for catch-at-age of surveys (logistic shaped fixed selectivity across all years)"}
include_graphics(file.path(path_mod,"fig_Sel_surveys.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

But, it is important to remark that the selectivity assumption for *ECOCADIZ* survey was different from the others, and it was separated into two different periods: 2004 to 2014 and 2015 to 2023, this difference can be appreciated in Figure `r run_reference("fig_Sel_eco")`

```{r eval=F,fig.cap="ane.27.9a Southern stock. Estimated selectivity for catch-at-age of ECOCADIZ survey (logistic shaped fixed selectivity in two different periods 2004 to 2014 and 2015 to 2023)"}
include_graphics(file.path("output/run/S1.0_4FLEETS_SelECO/plots/"  ,"sel11_timevary_surf_flt6sex1.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

## Catchability

The catchability (q) is adjusted to maintain a consistent relationship between the observed biomass and the vulnerable biomass in acoustic surveys. As vulnerable biomass decreases throughout the year, catchability increases, indicating that efforts intensify when the vulnerable biomass is lower (Figure  `r run_reference("fig_catchability")` ).

```{r fig.cap="ane.27.9a Southern stock. Estimated catchability parameters for the different surveys indices."}
include_graphics(file.path(path_mod,"fig_catchability.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```




## Estimated time series

The Figure  `r run_reference("fig_time_series")` shows that  total biomass fluctuates around a historical mean of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a minimum in `r agg_Value2[agg_Value2$type == "Bt", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes and a maximum recorded in `r agg_Value2[agg_Value2$type == "Bt", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes. In 2023, the biomass is estimated to be `r round(1 - (data[data$type == "Bt" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Bt", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. The catch shows variability around the historical mean of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Catch", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes and a minimum in `r agg_Value2[agg_Value2$type == "Catch", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes.  In 2023, the catch is estimated to be `r round( (data[data$type == "Catch" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Catch", "Value.mean", drop = TRUE])-1, 2) * 100`% above the historical mean. 

The fishing mortality ($F_t$) fluctuates around a historical mean of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.mean", drop = TRUE], 2)`, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Ft", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.max", drop = TRUE], 2)` and a minimum in `r agg_Value2[agg_Value2$type == "Ft", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.min", drop = TRUE], 2)`. Confidence intervals range from `r round(agg_CV[agg_CV$type == "Ft", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "Ft", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "Ft", "Value.mean", drop = TRUE], 2)`.  The $F_{2023}$ is estimated to be `r round( (data[data$type == "Ft" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Ft", "Value.mean", drop = TRUE])-1, 2) * 100`% above the historical mean. 

The recruitment ($R_t$) fluctuates around a historical mean of  `r round(agg_Value2[agg_Value2$type == "Rt", "Value.mean", drop = TRUE] / 1000000, 2)` millions recruits, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Rt", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Rt", "Value.max", drop = TRUE] / 1000000, 2)` millions recruits and a minimum in `r agg_Value2[agg_Value2$type == "Rt", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Rt", "Value.min", drop = TRUE] / 1000000, 2)` millions recruits. Confidence intervals range from `r round(agg_CV[agg_CV$type == "Rt", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "Rt", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "Rt", "Value.mean", drop = TRUE], 2)`.  The $R_{2023}$ is estimated to be `r round(1- (data[data$type == "Rt" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Rt", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. 

Finally, the spawning biomass ($SSB_{t}$) varies around a historical mean of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "SSB", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes and a minimum in `r agg_Value2[agg_Value2$type == "SSB", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes. Confidence intervals range from `r round(agg_CV[agg_CV$type == "SSB", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "SSB", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "SSB", "Value.mean", drop = TRUE], 2)`.The $SSB_{2023}$ is estimated to be `r round(1- (data[data$type == "SSB" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "SSB", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. 


```{r fig.cap="ane.27.9a Southern stock. Time series estimated by the model for annual catches (in tons), recruitment (millions of fish), total biomass and spawning biomass (in tons), and fishing mortality (year-1)."}
include_graphics(file.path(path_mod,"fig_time_series.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```

The summarised data resulting from model outputs is shown in Figure `r run_reference("tb_timeseries")`.



```{r fig.cap="ane.27.9a Southern stock. Time series estimated by the model for annual catches (in tons), recruitment (millions of fish), total biomass and spawning biomass (in tons), and fishing mortality (year-1)."}
include_graphics(file.path(path_mod,"tb_timeseries.png"), auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))
increment_figure_counter()
```



  

# Acknowledgements

Financial support was received for the work developed in this document. In particular, M. José Zúñiga work was funded by the Math4Fish project: New tools for mathematical modelling in Spanish fisheries scientific advice, financed by the European Union – NextGenerationEU, and the Recovery and Resilience Facility, Component 3, Investment 7 and has been carried out within the framework of the agreement between the Spanish Ministry of Agriculture, Fishing and Food and the Spanish National Research Council (CSIC) through the Spanish Institute of Oceanography (IEO) to promote fisheries research as a basis for sustainable fisheries management. Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or European Commission. Neither the European Union nor the European Commission can be held responsible for them.

Additionally, this work would have not been possible without the collection of Spanish fisheries and surveys data, co-funded by the Spanish Institute of Oceanography (IEO) and the EU through the European Maritime and Fisheries Fund (EMFF) within the National Program of collection, management and use of data in the fisheries sector and support for scientific advice regarding the Common Fisheries Policy (PNDB/EU-DCF-Programa Nacional de Datos Básicos/EU-Data Collection Framework). 

# References
